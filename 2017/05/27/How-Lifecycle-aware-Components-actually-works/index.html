<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Architecture,Lifecycle," />





  <link rel="alternate" href="/atom.xml" title="ChaosLeong's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="注：本文所有代码基于 android.arch.lifecycle 1.0.0-alpha1另外，为了避免混淆，Fragment、Activity 等组件自身的生命周期直用 “生命周期” 一词，而由 Lifecycle 框架提供的生命周期则称为 “lifecyle”

最近看到不少人讨论 Google 推的 Android Architecture Components，其中 Handling">
<meta property="og:type" content="article">
<meta property="og:title" content="Lifecycle-aware Components 源码分析">
<meta property="og:url" content="http://chaosleong.github.io/2017/05/27/How-Lifecycle-aware-Components-actually-works/index.html">
<meta property="og:site_name" content="ChaosLeong's Blog">
<meta property="og:description" content="注：本文所有代码基于 android.arch.lifecycle 1.0.0-alpha1另外，为了避免混淆，Fragment、Activity 等组件自身的生命周期直用 “生命周期” 一词，而由 Lifecycle 框架提供的生命周期则称为 “lifecyle”

最近看到不少人讨论 Google 推的 Android Architecture Components，其中 Handling">
<meta property="og:updated_time" content="2017-06-07T08:26:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lifecycle-aware Components 源码分析">
<meta name="twitter:description" content="注：本文所有代码基于 android.arch.lifecycle 1.0.0-alpha1另外，为了避免混淆，Fragment、Activity 等组件自身的生命周期直用 “生命周期” 一词，而由 Lifecycle 框架提供的生命周期则称为 “lifecyle”

最近看到不少人讨论 Google 推的 Android Architecture Components，其中 Handling">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chaosleong.github.io/2017/05/27/How-Lifecycle-aware-Components-actually-works/"/>





  <title> Lifecycle-aware Components 源码分析 | ChaosLeong's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ChaosLeong's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">边迷茫边努力，迷茫也不忘前进</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://chaosleong.github.io/2017/05/27/How-Lifecycle-aware-Components-actually-works/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chaos Leong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ChaosLeong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Lifecycle-aware Components 源码分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-27T12:13:16+08:00">
                2017-05-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/27/How-Lifecycle-aware-Components-actually-works/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/27/How-Lifecycle-aware-Components-actually-works/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>注：本文所有代码基于 android.arch.lifecycle 1.0.0-alpha1<br>另外，为了避免混淆，Fragment、Activity 等组件自身的生命周期直用 “生命周期” 一词，而由 <strong>Lifecycle</strong> 框架提供的生命周期则称为 “lifecyle”</p>
</blockquote>
<p>最近看到不少人讨论 Google 推的 <a href="https://developer.android.com/topic/libraries/architecture/index.html" target="_blank" rel="external">Android Architecture Components</a>，其中 <a href="https://developer.android.com/topic/libraries/architecture/lifecycle.html" target="_blank" rel="external">Handling Lifecycles</a> 一章展现了如何利用 <code>android.arch.lifecycle</code> 包提供的类来控制数据、监听器等的 lifecycle。同时，<a href="https://developer.android.com/topic/libraries/architecture/livedata.html" target="_blank" rel="external">LiveData</a> 与 <a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html" target="_blank" rel="external">ViewModel</a> 的 lifecycle 也依赖于 <strong>Lifecycle</strong> 框架，所以分析 <strong>Lifecycle</strong> 显然是有必要的。</p>
<p><strong>Lifecycle</strong> 到底是通过怎样的方式来绑定 Android 组件的生命周期以及如何通知 <strong>LifecycleObserver</strong> 状态变化的呢？本文将会围绕这两个问题深入分析 <strong>Lifecycle</strong> 源码。</p>
<a id="more"></a>
<h2 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h2><p>由于完整的 <strong>Lifecycle</strong> 分为 <code>common</code>, <code>core</code>, <code>extensions</code>, <code>runtime</code> 四个包，并包含 <strong>ViewModel</strong>、<strong>LiveData</strong> 部分内容。为了方便分析，利用 proguard(只添加 <code>-dontobfuscate</code>) 剔除所有不需要用到的类。</p>
<p>最终剩下的类：</p>
<p>android.arch.core.internal（<strong>core</strong>）</p>
<ul>
<li>SafeIterableMap</li>
</ul>
<p>android.arch.lifecycle（<strong>runtime</strong>）</p>
<ul>
<li>EmptyActivityLifecycleCallbacks</li>
<li>LifecycleActivity</li>
<li>LifecycleDispatcher</li>
<li>LifecycleFragment</li>
<li>LifecycleRegistry</li>
<li>LifecycleRegistryOwner</li>
<li>LifecycleRuntimeTrojanProvider</li>
<li>LifecycleService</li>
<li>ProcessLifecycleOwner</li>
<li>ReportFragment</li>
<li>ServiceLifecycleDispatcher</li>
</ul>
<p>android.arch.lifecycle（<strong>common</strong>）</p>
<ul>
<li>GenericLifecycleObserver</li>
<li>Lifecycle</li>
<li>LifecycleObserver</li>
<li>LifecycleOwner</li>
<li>Lifecycling</li>
<li>OnLifecycleEvent</li>
<li>ReflectiveGenericLifecycleObserver</li>
</ul>
<h2 id="Lifecycle-事件的生成过程"><a href="#Lifecycle-事件的生成过程" class="headerlink" title="Lifecycle 事件的生成过程"></a>Lifecycle 事件的生成过程</h2><p>先看 <strong>Lifecycle</strong> 的 AndroidManifest.xml（可以在 <code>build/outputs/logs/manifest-merger-*.txt</code> 中找到对应的路径）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">package</span>=<span class="string">"android.arch.lifecycle"</span></div><div class="line">    <span class="attr">android:versionCode</span>=<span class="string">"1"</span></div><div class="line">    <span class="attr">android:versionName</span>=<span class="string">"1.0"</span> &gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span></span></div><div class="line">        <span class="attr">android:minSdkVersion</span>=<span class="string">"14"</span></div><div class="line">        <span class="attr">android:targetSdkVersion</span>=<span class="string">"26"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">provider</span></span></div><div class="line">            <span class="attr">android:name</span>=<span class="string">"android.arch.lifecycle.LifecycleRuntimeTrojanProvider"</span></div><div class="line">            <span class="attr">android:authorities</span>=<span class="string">"$&#123;applicationId&#125;.lifecycle-trojan"</span></div><div class="line">            <span class="attr">android:exported</span>=<span class="string">"false"</span></div><div class="line">            <span class="attr">android:multiprocess</span>=<span class="string">"true"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure>
<p>可以看到 <strong>Lifecycle</strong>框架会给应用添加一个 <code>exported=&quot;false&quot;</code> 的  <strong>LifecycleRuntimeTrojanProvider</strong>。</p>
<h3 id="LifecycleRuntimeTrojanProvider"><a href="#LifecycleRuntimeTrojanProvider" class="headerlink" title="LifecycleRuntimeTrojanProvider"></a>LifecycleRuntimeTrojanProvider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Internal class to initialize Lifecycles.</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleRuntimeTrojanProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        LifecycleDispatcher.init(getContext());</div><div class="line">        ProcessLifecycleOwner.init(getContext());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>javadoc 已经写得很明显，<strong>LifecycleRuntimeTrojanProvider</strong> 就是用于初始化 <strong>Lifecycle</strong> 框架的，其余 ContentProvider 应实现的方法返回的均为默认值（null 或 0），顺着代码先看 <strong>LifecycleDispatcher</strong>。</p>
<h3 id="LifecycleDispatcher"><a href="#LifecycleDispatcher" class="headerlink" title="LifecycleDispatcher"></a>LifecycleDispatcher</h3><p><strong>LifecycleDispatcher</strong> 的初始化代码比较简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> AtomicBoolean sInitialized = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sInitialized.getAndSet(<span class="keyword">true</span>)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   ((Application) context.getApplicationContext())</div><div class="line">           .registerActivityLifecycleCallbacks(<span class="keyword">new</span> DispatcherActivityCallback());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要就是注册了一个 ActivityLifecycleCallbacks —— <strong>DispatcherActivityCallback</strong>。</p>
<h4 id="DispatcherActivityCallback"><a href="#DispatcherActivityCallback" class="headerlink" title="DispatcherActivityCallback"></a>DispatcherActivityCallback</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherActivityCallback</span> <span class="keyword">extends</span> <span class="title">EmptyActivityLifecycleCallbacks</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> FragmentCallback mFragmentCallback;</div><div class="line"></div><div class="line">   DispatcherActivityCallback() &#123;</div><div class="line">       mFragmentCallback = <span class="keyword">new</span> FragmentCallback();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</div><div class="line">           ((FragmentActivity) activity).getSupportFragmentManager()</div><div class="line">                   .registerFragmentLifecycleCallbacks(mFragmentCallback, <span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ProcessLifecycleOwner should always correctly work and some activities may not extend</span></div><div class="line">       <span class="comment">// FragmentActivity from support lib, so we use framework fragments for activities</span></div><div class="line">       android.app.FragmentManager manager = activity.getFragmentManager();</div><div class="line">       <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</div><div class="line">           manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</div><div class="line">           <span class="comment">// Hopefully, we are the first to make a transaction.</span></div><div class="line">           manager.executePendingTransactions();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</div><div class="line">           markState((FragmentActivity) activity, CREATED);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivitySaveInstanceState</span><span class="params">(Activity activity, Bundle outState)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</div><div class="line">           markState((FragmentActivity) activity, CREATED);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>DispatcherActivityCallback</strong> 的 <code>onActivityStopped</code> 和 <code>onActivitySaveInstanceState</code> 方法会将 LifecycleRegistryOwner 的状态重置成 <code>CREATED</code>（为何是 <code>CREATED</code> 可以查看 <a href="https://developer.android.com/topic/libraries/architecture/lifecycle.html#lc" target="_blank" rel="external">Lifecycle 的状态图</a> 及 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html" target="_blank" rel="external">各状态的描述</a>）。再看 <code>onActivityCreated</code>，当 activity 是 FragmentActivity 时，额外注册 FragmentLifecycleCallbacks —— <strong>FragmentCallback</strong>，紧接着将 <strong>ReportFragment</strong> 添加到 activity 中。考虑到并不是所有人都会使用 FragmentActivity，所以添加 <strong>ReportFragment</strong> 时使用的是原生的 FragmentManager。</p>
<h4 id="ReportFragment"><a href="#ReportFragment" class="headerlink" title="ReportFragment"></a>ReportFragment</h4><p>先来看一下 <strong>ReportFragment</strong> 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ActivityInitializationListener mProcessListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">            listener.onCreate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStart</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">            listener.onStart();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchResume</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">            listener.onResume();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">        dispatchCreate(mProcessListener);</div><div class="line">        dispatch(Lifecycle.Event.ON_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStart();</div><div class="line">        dispatchStart(mProcessListener);</div><div class="line">        dispatch(Lifecycle.Event.ON_START);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        dispatchResume(mProcessListener);</div><div class="line">        dispatch(Lifecycle.Event.ON_RESUME);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onPause();</div><div class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStop();</div><div class="line">        dispatch(Lifecycle.Event.ON_STOP);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</div><div class="line">        <span class="comment">// just want to be sure that we won't leak reference to an activity</span></div><div class="line">        mProcessListener = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getActivity() <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</div><div class="line">            ((LifecycleRegistryOwner) getActivity()).getLifecycle().handleLifecycleEvent(event);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setProcessListener</span><span class="params">(ActivityInitializationListener processListener)</span> </span>&#123;</div><div class="line">        mProcessListener = processListener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ActivityInitializationListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以看出 <strong>ReportFragment</strong> 在生命周期发生变化时会生成对应的 lifecycle 事件并通过 <code>dispatch(event)</code> 将事件发送到 <strong>Lifecycle</strong> 的 <code>handleLifecycleEvent(event)</code> 方法中。此外还会在 <code>onActivityCreated</code>, <code>onStart</code>, <code>onResume</code> 时额外通知 <strong>ActivityInitializationListener</strong>（暂且记住，后面会用到）。可能会有读者有疑问，为什么要使用 <strong>ReportFragment</strong> 的生命周期而不直接使用 ActivityLifecycleCallbacks 的回调来处理 lifecycle 的变化？由于 ActivityLifecycleCallbacks 的回调比 Fragment 和 Activity 还要早，实际上未真正执行对应的生命周期方法。至于为什么用 Fragment 而不直接重写 Activity 的生命周期，显然用 Fragment 侵入性低。</p>
<h4 id="FragmentCallback"><a href="#FragmentCallback" class="headerlink" title="FragmentCallback"></a>FragmentCallback</h4><p>再看回 <strong>FragmentCallback</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentCallback</span> <span class="keyword">extends</span> <span class="title">FragmentManager</span>.<span class="title">FragmentLifecycleCallbacks</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFragmentCreated</span><span class="params">(FragmentManager fm, Fragment f, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">       dispatchIfLifecycleOwner(f, ON_CREATE);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!(f <span class="keyword">instanceof</span> LifecycleRegistryOwner)) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (f.getChildFragmentManager().findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</div><div class="line">           f.getChildFragmentManager().beginTransaction().add(<span class="keyword">new</span> DestructionReportFragment(),</div><div class="line">                   REPORT_FRAGMENT_TAG).commit();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFragmentStarted</span><span class="params">(FragmentManager fm, Fragment f)</span> </span>&#123;</div><div class="line">       dispatchIfLifecycleOwner(f, ON_START);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFragmentResumed</span><span class="params">(FragmentManager fm, Fragment f)</span> </span>&#123;</div><div class="line">       dispatchIfLifecycleOwner(f, ON_RESUME);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatchIfLifecycleOwner</span><span class="params">(Fragment fragment, Lifecycle.Event event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (fragment <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</div><div class="line">       ((LifecycleRegistryOwner) fragment).getLifecycle().handleLifecycleEvent(event);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>FragmentCallback</strong> 在 <code>onFragmentCreated</code>, <code>onFragmentStarted</code>, <code>onFragmentResumed</code> 分别生成了 <code>ON_CREATE</code>, <code>ON_START</code>, <code>ON_RESUME</code> 三个 lifecycle 事件。</p>
<p>与 <strong>DispatcherActivityCallback</strong> 类似，当 Fragment 为 Parent Fragment 且实现了 LifecycleRegistryOwner 接口时，FragmentCallback 会添加一个 Child Fragment —— <strong>DestructionReportFragment</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DestructionReportFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onPause();</div><div class="line">       dispatch(ON_PAUSE);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onStop();</div><div class="line">       dispatch(ON_STOP);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onDestroy();</div><div class="line">       dispatch(ON_DESTROY);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</div><div class="line">       dispatchIfLifecycleOwner(getParentFragment(), event);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里我们可以看出，<strong>DestructionReportFragment</strong> 会在 <code>onPause</code>, <code>onStop</code>, <code>onDestroy</code> 中生成对应的 lifecycle 事件并转发到 Parent Fragment 中。</p>
<p>结合 <strong>FragmentCallback</strong> 和 <strong>DestructionReportFragment</strong>，我们可以知道 <strong>FragmentCallback</strong> 混合了 FragmentLifecycleCallbacks 及 Fragment 的生命周期来通知通过 ChildFragmentManager 添加的其他 Child Fragments（LifecycleObserver）lifecycle 发生变化。这样做是为了确保 <code>ON_CREATE</code>, <code>ON_START</code>, <code>ON_RESUME</code> 发生在相应的生命周期之后，<code>ON_PAUSE</code>, <code>ON_STOP</code>, <code>ON_DESTROY</code> 发生在相应的生命周期之前（不明白的可参考 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="external">Lifecycle</a>）。</p>
<p>所以 <strong>FragmentCallback</strong> 主要是通知 Parent Fragment（LifecycleRegistryOwner）lifecycle 发生变化，从而给 Child Fragment（LifecycleObserver）分发 lifecycle 事件。</p>
<p>值得注意的是，由于 FragmentLifecycleCallbacks 只存在于 v4 包中，当 Child 是 android.app.Fragment 时，即使 Child 已经通过 <code>((LifecycleRegistryOwner) getParentFragment()).getLifecycle().addObserver(this)</code> 注册了监听，此后 Child Fragment 相关生命周期发生变化时也不会接收到相应的 lifecycle 事件，因为没有对应的生产者。（暂时未知 Google 是有意为之，抑或是个 BUG。）</p>
<h3 id="ProcessLifecycleOwner"><a href="#ProcessLifecycleOwner" class="headerlink" title="ProcessLifecycleOwner"></a>ProcessLifecycleOwner</h3><p>看完 <strong>LifecycleDispatcher</strong>，接着来了解一下 <strong>ProcessLifecycleOwner</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessLifecycleOwner</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@VisibleForTesting</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIMEOUT_MS = <span class="number">700</span>; <span class="comment">//mls</span></div><div class="line"></div><div class="line">    <span class="comment">// ground truth counters</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mStartedCounter = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mResumedCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mPauseSent = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mStopSent = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler mHandler;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LifecycleRegistry mRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Runnable mDelayedPauseRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            dispatchPauseIfNeeded();</div><div class="line">            dispatchStopIfNeeded();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ActivityInitializationListener mInitializationListener =</div><div class="line">            <span class="keyword">new</span> ActivityInitializationListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">                    activityStarted();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">                    activityResumed();</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessLifecycleOwner sInstance = <span class="keyword">new</span> ProcessLifecycleOwner();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleOwner <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        sInstance.attach(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activityStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStartedCounter++;</div><div class="line">        <span class="keyword">if</span> (mStartedCounter == <span class="number">1</span> &amp;&amp; mStopSent) &#123;</div><div class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</div><div class="line">            mStopSent = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activityResumed</span><span class="params">()</span> </span>&#123;</div><div class="line">        mResumedCounter++;</div><div class="line">        <span class="keyword">if</span> (mResumedCounter == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mPauseSent) &#123;</div><div class="line">                mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</div><div class="line">                mPauseSent = <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mHandler.removeCallbacks(mDelayedPauseRunnable);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">        mResumedCounter--;</div><div class="line">        <span class="keyword">if</span> (mResumedCounter == <span class="number">0</span>) &#123;</div><div class="line">            mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activityStopped</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStartedCounter--;</div><div class="line">        dispatchStopIfNeeded();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchPauseIfNeeded</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mResumedCounter == <span class="number">0</span>) &#123;</div><div class="line">            mPauseSent = <span class="keyword">true</span>;</div><div class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStopIfNeeded</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mStartedCounter == <span class="number">0</span> &amp;&amp; mPauseSent) &#123;</div><div class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);</div><div class="line">            mStopSent = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ProcessLifecycleOwner</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mHandler = <span class="keyword">new</span> Handler();</div><div class="line">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</div><div class="line">        Application app = (Application) context.getApplicationContext();</div><div class="line">        app.registerActivityLifecycleCallbacks(<span class="keyword">new</span> EmptyActivityLifecycleCallbacks() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">                LifecycleDispatcher.get(activity).setProcessListener(mInitializationListener);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">                activityPaused();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">                activityStopped();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRegistry;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>比起 <strong>LifecycleDispatcher</strong>，<strong>ProcessLifecycleOwner</strong> 的代码要简单得多。<strong>ProcessLifecycleOwner</strong> 的作用就是根据当前进程中 Activity 的状态变化统计 Activity 的数量从而得出当前进程的变化并通知 LifecycleObserver lifecycle 发生变化。</p>
<p>而为了达到这一目的，<strong>ProcessLifecycleOwner</strong> 的做法是为 <strong>LifecycleDispatcher</strong> 注册 <strong>ActivityInitializationListener</strong> 以确保 Activity 进入了 <code>onStart</code> 或 <code>onResume</code> 生命周期（还记得前面 <strong>ReportFragment</strong> 提到的这部分内容？），并配合 ActivityLifecycleCallbacks 的 <code>onActivityPaused</code>, <code>onActivityStopped</code> 确保 lifecycle 事件发生在 Activity 的 <code>onPause</code>, <code>onStop</code> 之前。</p>
<p>需注意的是，由于 <strong>ProcessLifecycleOwner</strong> 没有 <code>ON_DESTROY</code>，当接收到 <code>ON_STOP</code> 时 lifecycle 已经结束。另外，<strong>ProcessLifecycleOwner</strong> 的统计不包含 Service，换句话说，即使接收到 <code>ON_STOP</code> 事件，并不意味着当前进程结束，只表示当前进程无存活的 Activity。</p>
<h3 id="LifecycleService"><a href="#LifecycleService" class="headerlink" title="LifecycleService"></a>LifecycleService</h3><p>了解完 Lifecycle 框架中 Activity、Fragment 相关的 lifecycle 事件是如何生成的，接下来就看一下 Service 又是怎么做的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleService</span> <span class="keyword">extends</span> <span class="title">Service</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceLifecycleDispatcher mDispatcher = <span class="keyword">new</span> ServiceLifecycleDispatcher(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDispatcher.onServicePreSuperOnCreate();</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        mDispatcher.onServicePreSuperOnBind();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        mDispatcher.onServicePreSuperOnStart();</div><div class="line">        <span class="keyword">super</span>.onStart(intent, startId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDispatcher.onServicePreSuperOnDestroy();</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mDispatcher.getLifecycle();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLifecycleDispatcher</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LifecycleRegistry mRegistry;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mHandler;</div><div class="line">    <span class="keyword">private</span> DispatchRunnable mLastDispatchRunnable;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceLifecycleDispatcher</span><span class="params">(@NonNull LifecycleOwner provider)</span> </span>&#123;</div><div class="line">        mRegistry = <span class="keyword">new</span> LifecycleRegistry(provider);</div><div class="line">        mHandler = <span class="keyword">new</span> Handler();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postDispatchRunnable</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mLastDispatchRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">            mLastDispatchRunnable.run();</div><div class="line">        &#125;</div><div class="line">        mLastDispatchRunnable = <span class="keyword">new</span> DispatchRunnable(mRegistry, event);</div><div class="line">        mHandler.postAtFrontOfQueue(mLastDispatchRunnable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServicePreSuperOnCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        postDispatchRunnable(Lifecycle.Event.ON_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServicePreSuperOnBind</span><span class="params">()</span> </span>&#123;</div><div class="line">        postDispatchRunnable(Lifecycle.Event.ON_START);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServicePreSuperOnStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        postDispatchRunnable(Lifecycle.Event.ON_START);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServicePreSuperOnDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        postDispatchRunnable(Lifecycle.Event.ON_STOP);</div><div class="line">        postDispatchRunnable(Lifecycle.Event.ON_DESTROY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRegistry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatchRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> LifecycleRegistry mRegistry;</div><div class="line">        <span class="keyword">final</span> Lifecycle.Event mEvent;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mWasExecuted = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        DispatchRunnable(<span class="meta">@NonNull</span> LifecycleRegistry registry, Lifecycle.Event event) &#123;</div><div class="line">            mRegistry = registry;</div><div class="line">            mEvent = event;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!mWasExecuted) &#123;</div><div class="line">                mRegistry.handleLifecycleEvent(mEvent);</div><div class="line">                mWasExecuted = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ServiceLifecycleDispatcher</strong> 用于协助 <strong>LifecycleService</strong> 分发 lifecycle 事件并确保每次发生变化时回调执行于 Handler 中。同时我们可以看到 <strong>LifecycleService</strong> 只会产生 <code>ON_CREATE</code>, <code>ON_START</code>, <code>ON_STOP</code>, <code>ON_DESTROY</code> 四种事件。</p>
<p>需注意的是继承 <strong>LifecycleService</strong> 时如需重写 <code>onStart</code> 或 <code>onStartCommand</code> 方法，必须调用 <code>super.onStart</code> 或 <code>super.onStartCommand</code> 以确保 <code>ON_START</code> 事件能够被触发。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>至此，我们了解到 <strong>Lifecycle</strong> 框架是如何将 lifecycle 事件与 Android 组件的生命周期绑定的：</p>
<ul>
<li><strong>LifecycleDispatcher</strong>，通过 ActivityLifecycleCallbacks、FragmentLifecycleCallbacks 及 Fragment 获知 Activity、Fragment 的生命周期变化并产生相应的 lifecycle 事件；</li>
<li><strong>ProcessLifecycleOwner</strong>，通过 ActivityLifecycleCallbacks 与 <strong>LifecycleDispatcher</strong> 配合监听当前进程中 Activities 的生命周期变化并在必要时产生相应的 lifecycle 事件；</li>
<li><strong>LifecycleService</strong>，通过重写 Service 的生命周期方法并在相应方法内产生相应的 lifecycle 事件。</li>
</ul>
<h2 id="Lifecycle-事件的分发过程"><a href="#Lifecycle-事件的分发过程" class="headerlink" title="Lifecycle 事件的分发过程"></a>Lifecycle 事件的分发过程</h2><p>在之前的分析中我们就留意到 lifecycle 事件生成后均会通过 LifecycleOwner 或  LifecycleRegistryOwner（extends LifecycleOwner）的 <code>getLifecycle()</code> 获取 <strong>Lifecycle</strong> 类或 <strong>LifecycleRegistry</strong>（extends Lifecycle），再通过它的 <code>handleLifecycleEvent(event)</code> 进行事件的分发。</p>
<p>那么各个 <code>getLifecycle()</code> 是怎样的呢？我们来看一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> <span class="keyword">implements</span> <span class="title">LifecycleRegistryOwner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LifecycleRegistry mRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LifecycleRegistry <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRegistry;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">LifecycleRegistryOwner</span> </span>&#123;</div><div class="line">    LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LifecycleRegistry <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mLifecycleRegistry;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleService</span> <span class="keyword">extends</span> <span class="title">Service</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceLifecycleDispatcher mDispatcher = <span class="keyword">new</span> ServiceLifecycleDispatcher(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mDispatcher.getLifecycle();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLifecycleDispatcher</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LifecycleRegistry mRegistry;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceLifecycleDispatcher</span><span class="params">(@NonNull LifecycleOwner provider)</span> </span>&#123;</div><div class="line">        mRegistry = <span class="keyword">new</span> LifecycleRegistry(provider);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRegistry;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码我们知道，<strong>LifecycleActivity</strong>、<strong>LifecycleFragment</strong>、<strong>LifecycleService</strong> 的 <code>getLifecycle()</code> 返回的均为 <strong>LifecycleRegistry</strong>（<strong>ProcessLifecycleOwner</strong> 也一样）。</p>
<h3 id="LifecycleRegistry-的-addObserver-流程"><a href="#LifecycleRegistry-的-addObserver-流程" class="headerlink" title="LifecycleRegistry 的 addObserver 流程"></a>LifecycleRegistry 的 addObserver 流程</h3><p>因为接收 lifecycle 事件都需先通过 <strong>Lifecycle</strong> 的 <code>addObserver</code> 注册 LifecycleObserver，所以我们先了解一下 <strong>LifecycleRegistry</strong> 中 <code>addObserver</code> 的内部逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> SafeIterableMap&lt;LifecycleObserver, ObserverWithState&gt; mObserverSet =</div><div class="line">       <span class="keyword">new</span> SafeIterableMap&lt;&gt;();</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(LifecycleObserver observer)</span> </span>&#123;</div><div class="line">   ObserverWithState observerWithState = <span class="keyword">new</span> ObserverWithState(observer);</div><div class="line">   mObserverSet.putIfAbsent(observer, observerWithState);</div><div class="line">   observerWithState.sync();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> State mObserverCurrentState = INITIALIZED;</div><div class="line">   <span class="keyword">private</span> GenericLifecycleObserver mCallback;</div><div class="line"></div><div class="line">   ObserverWithState(LifecycleObserver observer) &#123;</div><div class="line">       mCallback = Lifecycling.getCallback(observer);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <strong>SafeIterableMap</strong> 是一个可在遍历过程中进行修改的 <code>Iterable&lt;Map.Entry&lt;K, V&gt;&gt;</code>。</p>
<p>在调用 <strong>LifecycleRegistry</strong> 的 <code>addObserver</code> 方法时，LifecycleObserver 被传至 <strong>ObserverWithState</strong> 并通过 <code>Lifecycling.getCallback(observer)</code> 生成 <strong>GenericLifecycleObserver</strong>。</p>
<h4 id="Lifecycling"><a href="#Lifecycling" class="headerlink" title="Lifecycling"></a>Lifecycling</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span></div><div class="line"><span class="function"><span class="keyword">static</span> GenericLifecycleObserver <span class="title">getCallback</span><span class="params">(Object object)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (object <span class="keyword">instanceof</span> GenericLifecycleObserver) &#123;</div><div class="line">       <span class="keyword">return</span> (GenericLifecycleObserver) object;</div><div class="line">   &#125;</div><div class="line">   ... <span class="comment">// try</span></div><div class="line">       <span class="keyword">final</span> Class&lt;?&gt; klass = object.getClass();</div><div class="line">       Constructor&lt;? extends GenericLifecycleObserver&gt; cachedConstructor;</div><div class="line">       ... <span class="comment">// 缓存部分</span></div><div class="line">       cachedConstructor = getGeneratedAdapterConstructor(klass);</div><div class="line">       <span class="keyword">if</span> (cachedConstructor != <span class="keyword">null</span>) &#123;</div><div class="line">           sCallbackCache.put(klass, cachedConstructor);</div><div class="line">           <span class="keyword">if</span> (!cachedConstructor.isAccessible()) &#123;</div><div class="line">               cachedConstructor.setAccessible(<span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> cachedConstructor.newInstance(object);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sCallbackCache.put(klass, sREFLECTIVE);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveGenericLifecycleObserver(object);</div><div class="line">   ... <span class="comment">// catch</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当调用 <code>getCallback</code> 时，<strong>Lifecycling</strong> 会根据传入的 Object（LifecycleObserver）调用 <code>getGeneratedAdapterConstructor</code>。</p>
<h5 id="LifecycleAdapter-的实例化"><a href="#LifecycleAdapter-的实例化" class="headerlink" title="LifecycleAdapter 的实例化"></a>LifecycleAdapter 的实例化</h5><p>接着看 <code>getGeneratedAdapterConstructor</code> 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Nullable</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends GenericLifecycleObserver&gt; getGeneratedAdapterConstructor(</div><div class="line">       Class&lt;?&gt; klass) &#123;</div><div class="line">   <span class="keyword">final</span> String fullPackage = klass.getPackage().getName();</div><div class="line"></div><div class="line">   String name = klass.getCanonicalName();</div><div class="line">   <span class="comment">// anonymous class bug:35073837</span></div><div class="line">   <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">final</span> String adapterName = getAdapterName(fullPackage.isEmpty() ? name :</div><div class="line">           name.substring(fullPackage.length() + <span class="number">1</span>));</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       <span class="keyword">final</span> Class&lt;? extends GenericLifecycleObserver&gt; aClass =</div><div class="line">               (Class&lt;? extends GenericLifecycleObserver&gt;) Class.forName(</div><div class="line">                       fullPackage.isEmpty() ? adapterName : fullPackage + <span class="string">"."</span> + adapterName);</div><div class="line">       <span class="keyword">return</span> aClass.getDeclaredConstructor(klass);</div><div class="line">   &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">       <span class="keyword">final</span> Class&lt;?&gt; superclass = klass.getSuperclass();</div><div class="line">       <span class="keyword">if</span> (superclass != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// 找不到 LifecycleAdapter 时获取父类的 LifecycleAdapter</span></div><div class="line">           <span class="keyword">return</span> getGeneratedAdapterConstructor(superclass);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">       <span class="comment">// this should not happen</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getAdapterName</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> className.replace(<span class="string">"."</span>, <span class="string">"_"</span>) + <span class="string">"_LifecycleAdapter"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不难看出，<code>getGeneratedAdapterConstructor</code> 主要是获取 annotationProcessor 生成的 <strong>xxx_LifecycleAdapter</strong>（关于 <strong>LifecycleAdapter</strong> 后面补充说明）的构造函数，并实例化返回到 <code>getCallback</code> 中。需注意的是，如果找不到 <strong>LifecycleAdapter</strong> 且 object(LifecycleObserver) 存在父类时会试图获取父类的 <strong>LifecycleAdapter</strong>（估计是为了应对混淆时只混淆了子类的情况）。</p>
<h5 id="ReflectiveGenericLifecycleObserver-的实例化"><a href="#ReflectiveGenericLifecycleObserver-的实例化" class="headerlink" title="ReflectiveGenericLifecycleObserver 的实例化"></a>ReflectiveGenericLifecycleObserver 的实例化</h5><p>当获取 <strong>LifecycleAdapter</strong> 失败后，<strong>Lifecycling</strong> 会直接实例化 <strong>ReflectiveGenericLifecycleObserver</strong> 作为替代（估计也是为了应对混淆）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectiveGenericLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mWrapped;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CallbackInfo mInfo;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class, CallbackInfo&gt; sInfoCache = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;</div><div class="line">        mWrapped = wrapped;</div><div class="line">        mInfo = getInfo(mWrapped.getClass());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CallbackInfo <span class="title">getInfo</span><span class="params">(Class klass)</span> </span>&#123;</div><div class="line">        CallbackInfo existing = sInfoCache.get(klass);</div><div class="line">        <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> existing;</div><div class="line">        &#125;</div><div class="line">        existing = createInfo(klass);</div><div class="line">        <span class="keyword">return</span> existing;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ReflectiveGenericLifecycleObserver</strong> 在实例化时会获取 Object（LifecycleObserver）的 class 并作为参数调用 <code>createInfo</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CallbackInfo <span class="title">createInfo</span><span class="params">(Class klass)</span> </span>&#123;</div><div class="line">   Method[] methods = klass.getDeclaredMethods();</div><div class="line">   List&lt;MethodReference&gt; methodReferences = <span class="keyword">null</span>;</div><div class="line">   Set&lt;Event&gt; allEvents = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">       OnLifecycleEvent annotation = method.getAnnotation(OnLifecycleEvent.class);</div><div class="line">       <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       Class&lt;?&gt;[] params = method.getParameterTypes();</div><div class="line">       <span class="keyword">int</span> callType = CALL_TYPE_NO_ARG;</div><div class="line">       <span class="keyword">if</span> (params.length &gt; <span class="number">0</span>) &#123;</div><div class="line">           callType = CALL_TYPE_PROVIDER;</div><div class="line">           <span class="comment">// 有参第一个参数必须为 LifecycleOwner</span></div><div class="line">           <span class="keyword">if</span> (!params[<span class="number">0</span>].isAssignableFrom(LifecycleOwner.class)) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                       <span class="string">"invalid parameter type. Must be one and instanceof LifecycleOwner"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (params.length &gt; <span class="number">1</span>) &#123;</div><div class="line">           callType = CALL_TYPE_PROVIDER_WITH_EVENT;</div><div class="line">           <span class="comment">// 有两个参数时第二个参数必须为 Event</span></div><div class="line">           <span class="keyword">if</span> (!params[<span class="number">1</span>].isAssignableFrom(Event.class)) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                       <span class="string">"invalid parameter type. second arg must be an event"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (params.length &gt; <span class="number">2</span>) &#123;</div><div class="line">           <span class="comment">// 最多只能有两个参数</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cannot have more than 2 params"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (methodReferences == <span class="keyword">null</span>) &#123;</div><div class="line">           methodReferences = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 获取应该执行回调的事件集</span></div><div class="line">       Set&lt;Event&gt; events = expandOnAnyEvents(annotation.value());</div><div class="line">       methodReferences.add(<span class="keyword">new</span> MethodReference(events, callType, method));</div><div class="line">       allEvents.addAll(events);</div><div class="line">   &#125;</div><div class="line">   CallbackInfo info = <span class="keyword">new</span> CallbackInfo(allEvents, methodReferences);</div><div class="line">   sInfoCache.put(klass, info);</div><div class="line">   Class superclass = klass.getSuperclass();</div><div class="line">   <span class="keyword">if</span> (superclass != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// 获取父类中带 OnLifecycleEvent 注解的方法集及事件集等</span></div><div class="line">       info.mSuper = getInfo(superclass);</div><div class="line">   &#125;</div><div class="line">   Class[] interfaces = klass.getInterfaces();</div><div class="line">   <span class="comment">// 获取接口中带 OnLifecycleEvent 注解的方法集及事件集等</span></div><div class="line">   <span class="keyword">for</span> (Class intrfc : interfaces) &#123;</div><div class="line">       CallbackInfo interfaceInfo = getInfo(intrfc);</div><div class="line">       <span class="keyword">if</span> (!interfaceInfo.mEvents.isEmpty()) &#123;</div><div class="line">           <span class="keyword">if</span> (info.mInterfaces == <span class="keyword">null</span>) &#123;</div><div class="line">               info.mInterfaces = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">           &#125;</div><div class="line">           info.mInterfaces.add(interfaceInfo);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> info;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackInfo</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Set&lt;Event&gt; mEvents;</div><div class="line">   <span class="meta">@Nullable</span></div><div class="line">   List&lt;MethodReference&gt; mMethodReferences;</div><div class="line">   <span class="meta">@Nullable</span></div><div class="line">   List&lt;CallbackInfo&gt; mInterfaces;</div><div class="line">   <span class="meta">@Nullable</span></div><div class="line">   CallbackInfo mSuper;</div><div class="line"></div><div class="line">   CallbackInfo(Set&lt;Event&gt; events, <span class="meta">@Nullable</span> List&lt;MethodReference&gt; methodReferences) &#123;</div><div class="line">       mEvents = events;</div><div class="line">       mMethodReferences = methodReferences;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodReference</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Set&lt;Event&gt; mEvents;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> mCallType;</div><div class="line">   <span class="keyword">final</span> Method mMethod;</div><div class="line"></div><div class="line">   MethodReference(Set&lt;Event&gt; events, <span class="keyword">int</span> callType, Method method) &#123;</div><div class="line">       mEvents = events;</div><div class="line">       mCallType = callType;</div><div class="line">       mMethod = method;</div><div class="line">       mMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Event&gt; <span class="title">expandOnAnyEvents</span><span class="params">(Event[] events)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> hasOnAllEvents = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">for</span> (Event e: events) &#123;</div><div class="line">       <span class="keyword">if</span> (e == Event.ON_ANY) &#123;</div><div class="line">           hasOnAllEvents = <span class="keyword">true</span>;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (!hasOnAllEvents) &#123;</div><div class="line">       HashSet&lt;Event&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">       Collections.addAll(set, events);</div><div class="line">       <span class="keyword">return</span> set;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> ALL_EVENTS;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Event&gt; ALL_EVENTS = <span class="keyword">new</span> HashSet&lt;Event&gt;() &#123;</div><div class="line">   &#123;</div><div class="line">       add(Event.ON_CREATE);</div><div class="line">       add(Event.ON_START);</div><div class="line">       add(Event.ON_RESUME);</div><div class="line">       add(Event.ON_PAUSE);</div><div class="line">       add(Event.ON_STOP);</div><div class="line">       add(Event.ON_DESTROY);</div><div class="line">   &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALL_TYPE_NO_ARG = <span class="number">0</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALL_TYPE_PROVIDER = <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALL_TYPE_PROVIDER_WITH_EVENT = <span class="number">2</span>;</div></pre></td></tr></table></figure>
<p>从上面的代码可以了解到，<code>createInfo</code> 主要是获取所有带 <strong>OnLifecycleEvent</strong> 注解的方法，在判断这些方法的合法性后，根据对应方法的参数个数、事件类型及方法名实例化 <strong>MethodReference</strong> 并添加到 <code>List&lt;MethodReference&gt;</code> 中，同时亦会将 Object(LifecycleObserver) 涉及的所有事件类型保存到 <code>Set&lt;Event&gt;</code> 中。当遍历完 Object(LifecycleObserver) 定义的所有方法后，会根据 <code>List&lt;MethodReference&gt;</code> 和 <code>Set&lt;Event&gt;</code> 实例化 <strong>CallbackInfo</strong> 并缓存至 <em>sInfoCache</em>。最后对 Object(LifecycleObserver) 的父类和接口执行同样的操作（即以它们作为参数传入 <code>createInfo</code>），并将返回的 <strong>CallbackInfo</strong> 分别赋值给 <code>info.mSuper</code> 和 <code>info.mInterfaces</code> 供后面使用。</p>
<h4 id="ObserverWithState-的-sync-流程"><a href="#ObserverWithState-的-sync-流程" class="headerlink" title="ObserverWithState 的 sync 流程"></a>ObserverWithState 的 sync 流程</h4><p>在 <strong>GenericLifecycleObserver</strong> 的实例化完成后，<code>addObserver</code> 会调用 <strong>ObserverWithState</strong> 的 <code>sync</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">observerWithState.sync();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mState == DESTROYED &amp;&amp; mObserverCurrentState == INITIALIZED) &#123;</div><div class="line">      mObserverCurrentState = DESTROYED;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">while</span> (mObserverCurrentState != mState) &#123;</div><div class="line">      Event event = mObserverCurrentState.isAtLeast(mState)</div><div class="line">              ? downEvent(mObserverCurrentState) : upEvent(mObserverCurrentState);</div><div class="line">      mObserverCurrentState = getStateAfter(event);</div><div class="line">      mCallback.onStateChanged(mLifecycleOwner, event);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>mState</code> 表示的是 <strong>LifecycleRegistry</strong> 当前所处的状态。</p>
<p>如果当前 <strong>LifecycleRegistry</strong> 处于 <code>DESTROYED</code>，<strong>ObserverWithState</strong> 处于 <code>INITIALIZED</code> 时，<strong>ObserverWithState</strong> 会直接进入 <code>DESTROYED</code>，并且此时 LifecycleObserver 不会收到任何回调。</p>
<p>当 <strong>ObserverWithState</strong> 与 <strong>LifecycleRegistry</strong> 的状态不相同时，<strong>ObserverWithState</strong> 会通过 <code>mObserverCurrentState.isAtLeast(mState)</code> 比较自身状态是高于或低于 <strong>LifecycleRegistry</strong> 的状态。状态的高低顺序（升序）如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</div><div class="line">   DESTROYED,</div><div class="line">   INITIALIZED,</div><div class="line">   CREATED,</div><div class="line">   STARTED,</div><div class="line">   RESUMED;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(State state)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 <strong>ObserverWithState</strong> 的状态高于或低于 <strong>LifecycleRegistry</strong> 时，会分别调用 <code>downEvent</code> 或 <code>upEvent</code> 决定 LifecycleObserver 的下一个 lifecycle 事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> Event <span class="title">downEvent</span><span class="params">(State state)</span> </span>&#123;</div><div class="line">   <span class="keyword">switch</span> (state) &#123;</div><div class="line">       <span class="keyword">case</span> INITIALIZED:</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">       <span class="keyword">case</span> CREATED:</div><div class="line">           <span class="keyword">return</span> ON_DESTROY;</div><div class="line">       <span class="keyword">case</span> STARTED:</div><div class="line">           <span class="keyword">return</span> ON_STOP;</div><div class="line">       <span class="keyword">case</span> RESUMED:</div><div class="line">           <span class="keyword">return</span> ON_PAUSE;</div><div class="line">       <span class="keyword">case</span> DESTROYED:</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unexpected state value "</span> + state);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> Event <span class="title">upEvent</span><span class="params">(State state)</span> </span>&#123;</div><div class="line">   <span class="keyword">switch</span> (state) &#123;</div><div class="line">       <span class="keyword">case</span> INITIALIZED:</div><div class="line">       <span class="keyword">case</span> DESTROYED:</div><div class="line">           <span class="keyword">return</span> ON_CREATE;</div><div class="line">       <span class="keyword">case</span> CREATED:</div><div class="line">           <span class="keyword">return</span> ON_START;</div><div class="line">       <span class="keyword">case</span> STARTED:</div><div class="line">           <span class="keyword">return</span> ON_RESUME;</div><div class="line">       <span class="keyword">case</span> RESUMED:</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unexpected state value "</span> + state);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着 <strong>ObserverWithState</strong> 会将获得的事件类型传入 <code>getStateAfter</code> 中获取新的状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> State <span class="title">getStateAfter</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">   <span class="keyword">switch</span> (event) &#123;</div><div class="line">       <span class="keyword">case</span> ON_CREATE:</div><div class="line">       <span class="keyword">case</span> ON_STOP:</div><div class="line">           <span class="keyword">return</span> CREATED;</div><div class="line">       <span class="keyword">case</span> ON_START:</div><div class="line">       <span class="keyword">case</span> ON_PAUSE:</div><div class="line">           <span class="keyword">return</span> STARTED;</div><div class="line">       <span class="keyword">case</span> ON_RESUME:</div><div class="line">           <span class="keyword">return</span> RESUMED;</div><div class="line">       <span class="keyword">case</span> ON_DESTROY:</div><div class="line">           <span class="keyword">return</span> DESTROYED;</div><div class="line">       <span class="keyword">case</span> ON_ANY:</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unexpected event value "</span> + event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果修改完状态后 <strong>ObserverWithState</strong> 与 <strong>LifecycleRegistry</strong> 的状态依然不相同，上述过程会一直重复执行直到相同为止。例如，当 <strong>LifecycleRegistry</strong> 处于 <code>RESUMED</code> 而 <strong>ObserverWithState</strong> 处于 <code>INITIALIZED</code> 时，<strong>ObserverWithState</strong> 的状态会按照 <code>INITIALIZED -&gt; CREATED -&gt; STARTED -&gt; RESUMED</code> 这样的顺序变迁。</p>
<p>下面再来了解下每次状态变迁之后调用的 <code>OnStateChanged</code> 方法内部做了些什么。</p>
<p>从前面 <strong>GenericLifecycleObserver</strong> 的生成过程中我们可以知道，这里的分析也需要分为两种情况分析：</p>
<ul>
<li>LifecycleAdapter</li>
<li>ReflectiveGenericLifecycleObserver</li>
</ul>
<h5 id="LifecycleAdapter"><a href="#LifecycleAdapter" class="headerlink" title="LifecycleAdapter"></a>LifecycleAdapter</h5><p>由于没有找到 <strong>LifecycleProcessor</strong> 的源码，这里我就写了个 DataObserver 来让各位稍微了解一下 <strong>LifecycleAdapter</strong>（可在 build/generated/source/apt 中找到）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_ANY)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAny</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_CREATE)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_START)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_RESUME)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_PAUSE)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_STOP)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_DESTROY)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataObserver_LifecycleAdapter</span> <span class="keyword">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> DataObserver mReceiver;</div><div class="line"></div><div class="line">  DataObserver_LifecycleAdapter(DataObserver receiver) &#123;</div><div class="line">    <span class="keyword">this</span>.mReceiver = receiver;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner owner, Lifecycle.Event event)</span> </span>&#123;</div><div class="line">    mReceiver.onAny();</div><div class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_CREATE) &#123;</div><div class="line">      mReceiver.onCreate();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_START) &#123;</div><div class="line">      mReceiver.onStart();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_RESUME) &#123;</div><div class="line">      mReceiver.onResume();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_PAUSE) &#123;</div><div class="line">      mReceiver.onPause();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_STOP) &#123;</div><div class="line">      mReceiver.onStop();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</div><div class="line">      mReceiver.onDestroy();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getReceiver</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mReceiver;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从 DataObserver_LifecycleAdapter 中可以大概猜测到，<strong>LifecycleProcessor</strong> 生成的 <strong>LifecycleAdapter</strong> 会根据 LifecycleObserver 中带 <strong>OnLifecycleEvent</strong> 注解的方法生成 <code>onStateChanged</code>，而且 <code>onStateChanged</code> 会根据不同的事件分别执行 LifecycleObserver 中对应的方法。</p>
<h5 id="ReflectiveGenericLifecycleObserver"><a href="#ReflectiveGenericLifecycleObserver" class="headerlink" title="ReflectiveGenericLifecycleObserver"></a>ReflectiveGenericLifecycleObserver</h5><p>当 lifecycle 发生变化调用 <code>onStateChanged</code> 时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Event event)</span> </span>&#123;</div><div class="line">   invokeCallbacks(mInfo, source, event);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"ConstantConditions"</span>)</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallbacks</span><span class="params">(CallbackInfo info, LifecycleOwner source, Event event)</span> </span>&#123;</div><div class="line">   <span class="comment">// 当前 ReflectiveGenericLifecycleObserver 有无该事件的相关注解</span></div><div class="line">   <span class="keyword">if</span> (info.mEvents.contains(event)) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = info.mMethodReferences.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">           MethodReference reference = info.mMethodReferences.get(i);</div><div class="line">           invokeCallback(reference, source, event);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO prevent duplicate calls into the same method. Preferably while parsing</span></div><div class="line">   <span class="keyword">if</span> (info.mSuper != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// 交由此前传入的 LifecycleObserver 的父类处理</span></div><div class="line">       invokeCallbacks(info.mSuper, source, event);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (info.mInterfaces != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> size = info.mInterfaces.size();</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">           <span class="comment">// 交由此前传入的 LifecycleObserver 的接口处理</span></div><div class="line">           invokeCallbacks(info.mInterfaces.get(i), source, event);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(MethodReference reference, LifecycleOwner source, Event event)</span> </span>&#123;</div><div class="line">   <span class="comment">// MethodReference 是否包含该事件</span></div><div class="line">   <span class="keyword">if</span> (reference.mEvents.contains(event)) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">switch</span> (reference.mCallType) &#123;</div><div class="line">               <span class="keyword">case</span> CALL_TYPE_NO_ARG:</div><div class="line">                   reference.mMethod.invoke(mWrapped);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> CALL_TYPE_PROVIDER:</div><div class="line">                   reference.mMethod.invoke(mWrapped, source);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> CALL_TYPE_PROVIDER_WITH_EVENT:</div><div class="line">                   reference.mMethod.invoke(mWrapped, source, event);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to call observer method"</span>, e.getCause());</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ReflectiveGenericLifecycleObserver</strong> 会判断接收到的事件是否存在于 <code>createInfo</code> 生成的 <code>mInfo</code> 中的事件集之中。当存在时，会遍历此前缓存的方法列表并由 <strong>MethodReference</strong> 判断是否处理该事件。当需要处理时，会根据此前得到的 <code>callType</code> 决定传递哪些参数。同样的，在处理完 class（LifecycleObserver） 自身定义的方法后，会将事件分发给父类和接口的 <strong>MethodReference</strong> 处理。</p>
<h5 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h5><p>所以 <code>sync</code> 方法的用途是使 LifecycleObserver 的状态与 <code>LifecycleRegistry</code> 的状态同步并通知 LifecycleObserver 状态已经发生变化。</p>
<p>至此，<code>addObserver</code> 完成了自身的工作。</p>
<h3 id="handleLifecycleEvent-流程"><a href="#handleLifecycleEvent-流程" class="headerlink" title="handleLifecycleEvent 流程"></a>handleLifecycleEvent 流程</h3><p>从 <strong>ServiceLifecycleDispatcher</strong>, <strong>LifecycleDispatcher</strong> 等的源码我们可以看出所有 lifecycle 事件都是通过 <strong>LifecycleRegistry</strong> 的 <code>handleLifecycleEvent</code> 来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mLastEvent == event) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   mLastEvent = event;</div><div class="line">   mState = getStateAfter(event);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;LifecycleObserver, ObserverWithState&gt; entry : mObserverSet) &#123;</div><div class="line">       entry.getValue().sync();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有了前面的经验，我们就能很容易地知道当 lifecycle 发生变化时，<code>handleLifecycleEvent</code><br>会通过 <code>getStateAfter</code> 获取当前应处的状态并修改 <code>mState</code> 值，紧接着遍历所有 <strong>ObserverWithState</strong> 并调用他们的 <code>sync</code> 方法来同步且通知 LifecycleObserver 状态发生变化。</p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>至此，我们了解到当 <strong>LifecycleRegistry</strong> 的 <code>addObserver</code> 或 <code>handleLifecycleEvent</code> 被调用时，新的 lifecycle 事件会被传到 <strong>LifecycleAdapter</strong> 或 <strong>ReflectiveGenericLifecycleObserver</strong> 的 <code>onStateChanged</code> 中从而通知 LifecycleObserver lifecycle 发生变化。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>结合来看，lifecycle 事件可由 <strong>LifecycleDispatcher</strong>(ActivityLifecycleCallbacks, FragmentLifecycleCallbacks, Fragment), <strong>ProcessLifecycleOwner</strong>, <strong>LifecycleService</strong> 产生，并通过 <strong>LifecycleRegistry</strong>, <strong>LifecycleAdapter</strong>/<strong>ReflectiveGenericLifecycleObserver</strong> 传递给 LifecycleObserver。</p>
<p>至此，Lifecycle-aware Components 的基础框架分析完毕。</p>
<h3 id="稍微再说几句"><a href="#稍微再说几句" class="headerlink" title="稍微再说几句"></a>稍微再说几句</h3><ul>
<li>个人认为该框架最有趣的地方在于使用 <strong>ReportFragment</strong> 监听 Activity 的生命周期；</li>
<li>Lifecycle 确实能帮助我们分拆 <code>onCreate</code>, <code>onStart</code> 等生命周期方法内所做的初始化、销毁操作，避免过多的代码堆在生命周期方法之中。只不过与 MVP 一样，会增加不少类，很小的项目也没什么必要使用；</li>
<li>整个框架的代码比较干净利落，反正看起来压力不大，能学到的东西也不少。</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Architecture/" rel="tag"># Architecture</a>
          
            <a href="/tags/Lifecycle/" rel="tag"># Lifecycle</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/09/Building-AOSP-for-Nexus-3-maguro/" rel="next" title="Building AOSP for Nexus 3 (maguro)">
                <i class="fa fa-chevron-left"></i> Building AOSP for Nexus 3 (maguro)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Chaos Leong" />
          <p class="site-author-name" itemprop="name">Chaos Leong</p>
           
              <p class="site-description motion-element" itemprop="description">个人博客，技术分享</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前置工作"><span class="nav-number">1.</span> <span class="nav-text">前置工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lifecycle-事件的生成过程"><span class="nav-number">2.</span> <span class="nav-text">Lifecycle 事件的生成过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LifecycleRuntimeTrojanProvider"><span class="nav-number">2.1.</span> <span class="nav-text">LifecycleRuntimeTrojanProvider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LifecycleDispatcher"><span class="nav-number">2.2.</span> <span class="nav-text">LifecycleDispatcher</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DispatcherActivityCallback"><span class="nav-number">2.2.1.</span> <span class="nav-text">DispatcherActivityCallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReportFragment"><span class="nav-number">2.2.2.</span> <span class="nav-text">ReportFragment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FragmentCallback"><span class="nav-number">2.2.3.</span> <span class="nav-text">FragmentCallback</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProcessLifecycleOwner"><span class="nav-number">2.3.</span> <span class="nav-text">ProcessLifecycleOwner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LifecycleService"><span class="nav-number">2.4.</span> <span class="nav-text">LifecycleService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">2.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lifecycle-事件的分发过程"><span class="nav-number">3.</span> <span class="nav-text">Lifecycle 事件的分发过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LifecycleRegistry-的-addObserver-流程"><span class="nav-number">3.1.</span> <span class="nav-text">LifecycleRegistry 的 addObserver 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lifecycling"><span class="nav-number">3.1.1.</span> <span class="nav-text">Lifecycling</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LifecycleAdapter-的实例化"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">LifecycleAdapter 的实例化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ReflectiveGenericLifecycleObserver-的实例化"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">ReflectiveGenericLifecycleObserver 的实例化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ObserverWithState-的-sync-流程"><span class="nav-number">3.1.2.</span> <span class="nav-text">ObserverWithState 的 sync 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LifecycleAdapter"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">LifecycleAdapter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ReflectiveGenericLifecycleObserver"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">ReflectiveGenericLifecycleObserver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#小结-1"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#handleLifecycleEvent-流程"><span class="nav-number">3.2.</span> <span class="nav-text">handleLifecycleEvent 流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-2"><span class="nav-number">3.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最后"><span class="nav-number">4.</span> <span class="nav-text">最后</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#稍微再说几句"><span class="nav-number">4.1.</span> <span class="nav-text">稍微再说几句</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chaos Leong</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://chaosleongs-blog.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://chaosleong.github.io/2017/05/27/How-Lifecycle-aware-Components-actually-works/';
          this.page.identifier = '2017/05/27/How-Lifecycle-aware-Components-actually-works/';
          this.page.title = 'Lifecycle-aware Components 源码分析';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://chaosleongs-blog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  





  

  

  

  

</body>
</html>
